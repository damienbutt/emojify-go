name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  checks:
    name: Run Checks
    uses: ./.github/workflows/checks.yml

  release-prechecks:
    name: Release Pre-checks
    uses: ./.github/workflows/release-prechecks.yml
    secrets: inherit

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [checks, release-prechecks]
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Install dependencies
        run: make deps

      - name: Setup Rust Toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Install Rust tools
        run: |
          cargo install git-cliff
          cargo install typos

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}

      - name: Install Nix
        uses: cachix/install-nix-action@v31

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TOKEN: ${{ secrets.RELEASE_TOKEN }}
          AUR_SSH_PRIVATE_KEY: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          GPG_FINGERPRINT: ${{ secrets.GPG_FINGERPRINT }}

      - name: Update GitHub Release with Release Notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Uploading release notes to GitHub Release..."
          gh release edit ${{ github.ref_name }} --notes-file RELEASE_NOTES.md

      - name: Commit Changelog
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Committing updated CHANGELOG.md..."
          ./scripts/commit-changelog.sh ${{ github.ref_name }}
